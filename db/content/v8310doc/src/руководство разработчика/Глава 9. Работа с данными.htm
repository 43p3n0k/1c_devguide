<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=Windows-1251">
		<title>&#1043;&#1083;&#1072;&#1074;&#1072; 9. &#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1089; &#1076;&#1072;&#1085;&#1085;&#1099;&#1084;&#1080;</title>
		<LINK REL="stylesheet" href="/db/content/v8310doc/src/руководство разработчика/style.css?_=1496848987">
		<script charset="windows-1251" src="/db/content/v8310doc/src/руководство разработчика/script.js?_=1496848987" TYPE="text/javascript"></script>		<!--[if !IE]>--><script charset="windows-1251" src="/db/content/v8310doc/src/руководство разработчика/zeroclipboard.js?_=1496848987" TYPE="text/javascript"></script><!--<![endif]-->
	<meta name="robots" content="noarchive">
<meta name="googlebot" content="noarchive">
<link href="/db/content/v8310doc/src/руководство разработчика/глава 9. работа с данными.htm" rel="canonical">
<link href="/static/its.content.css?_=1490872753" type="text/css" rel="stylesheet">
<script charset="windows-1251" type="text/javascript" src="/static/its.content.js?_=1489758009"></script>
<!--[if lt IE 9]><script charset="windows-1251" type="text/javascript" src="/static/html5shiv.js?_=1484636606"></script><![endif]-->

</head>
	<body class="v8310doc">
<a name="_ref220404426"></a><a name="_ref414279683"></a><a name="_ref237783421"></a><a id="TI000000522" class="bookmark"><h1>Глава 9.  Работа с данными</h1></a>

<a id="TI000000523" class="bookmark" name="issogl1_9.1_механизм_объектных_блокировок"><h2>9.1. Механизм объектных блокировок</h2></a>

<a id="TI000001742" class="bookmark" name="issogl2_9.1.1_общая_информация"><h3>9.1.1. Общая информация</h3></a>

<p class="MsoNormal">При работе с объектными данными (справочники, документы,
счета и пр.) система «1С:Предприятие» обеспечивает два вида объектных
блокировок – <span class="Bold">пессимистическую</span> и <span class="Bold">оптимистическую</span>. Они
позволяют выполнять целостные изменения объектов при одновременной работе
нескольких пользователей.</p>

<a name="_ref421188804"></a><a name="_ref421188803"></a><a id="TI000000524" class="bookmark" name="issogl2_9.1.2_пессимистическая_блокировка"><h3>9.1.2. Пессимистическая блокировка</h3></a>

<p class="MsoNormalCxSpFirst">Механизм пессимистической блокировки объектов базы
данных предназначен для того, чтобы запретить изменение данных объекта другими
сеансами или данным сеансом до тех пор, пока блокировка не будет снята (автоматически
или с помощью методов встроенного языка).</p>

<p class="MsoNormalCxSpMiddle">В основном механизм пессимистической блокировки используется
системой «1С:Предприятие» для блокировки объектов, редактируемых в форме. В то
же время разработчик имеет возможность задействовать этот механизм, используя
средства встроенного языка.</p>

<p class="MsoNormalCxSpMiddle">Система «1С:Предприятие» использует механизм пессимистической
блокировки с помощью расширений форм прикладных объектов. В тот момент, когда
пользователь начинает модификацию объекта в форме, расширение формы устанавливает
пессимистическую блокировку. Если после этого другой пользователь, например,
попытается выполнить редактирование того же объекта, ему будет выдано сообщение
о том, что не удалось заблокировать объект. Когда пользователь, редактировавший
объект, закроет форму объекта, расширение формы снимет пессимистическую блокировку.</p>

<p class="MsoNormalCxSpMiddle">В том случае, если необходимо в нестандартной
форме объекта обеспечить такое же поведение, что и в стандартной форме объекта,
можно использовать метод формы <span class="Term">ЗаблокироватьДанныеФормыДляРедактирования()</span>
для установки пессимистической блокировки и метод формы <span class="Term">РазблокироватьДанныеФормыДляРедактирования()</span>
для снятия блокировки.</p>

<p class="MsoNormalCxSpLast">Разработчик, для того чтобы задействовать пессимистическую
блокировку, может использовать метод глобального контекста <span class="Term">ЗаблокироватьДанныеДляРедактирования()</span>.
Возможны два варианта установки пессимистической блокировки:</p>

<p class="MsoListBullet">&#9679; 
С указанием идентификатора формы – в этом
случае блокировка устанавливается на время жизни форм, в которой установлена
блокировка, и снимается автоматически при закрытии формы или завершении сеанса.
Важно, что блокировка может быть снята не сразу, а через некоторое время.
Блокировка будет снята сразу при выполнении любого из следующих условий:</p>

<p class="MsoListBullet2CxSpFirst">&#9679; 
за время отображения формы были установлены
другие блокировки от имени этой формы (при интерактивном редактировании или
методом <span class="Term">ЗаблокироватьДанныеФормыДляРедактирования()</span>);</p>

<p class="MsoListBullet2CxSpLast">&#9679; 
от имени этой формы были запущены и не завершены
фоновые задания (поиск в динамическом списке или формирование отчета).</p>

<p class="Indentlist">Также блокировка может быть снята с помощью метода
глобального контекста <span class="Term">РазблокироватьДанныеДляРедактирования()</span>
с указанием того же идентификатора формы, который указывался для установки
блокировки. В этом случае блокировка снимается сразу.</p>

<p class="MsoListBullet">&#9679; 
Без указания идентификатора формы – в этом
случае устанавливаемая блокировка не привязана к какой-либо форме. Блокировка
будет автоматически снята при завершении сеанса, при возврате управления с
сервера или при завершении транзакции (если блокировка устанавливалась в транзакции).
Также блокировка может быть снята с помощью метода глобального контекста <span class="Term">РазблокироватьДанныеДляРедактирования()</span>
без указания идентификатора формы.</p>

<p class="MsoNormal">Однако следует учитывать, что сам по себе факт установки
блокировки не препятствует изменению или удалению объекта в базе данных.
Поэтому для того, чтобы обеспечить невозможность изменения заблокированного
объекта, операции изменения объекта в другом сеансе также должна предшествовать
попытка блокировки этого объекта. Блокировка заблокированного объекта базы
данных вызывает исключение, которое может быть обработано конструкцией <span class="Term">Попытка … Исключение … КонецПопытки</span>.</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="preprocessor">&amp;НаСервере</span>
<span class="keyword">Функция</span> ПримерМодификации<span class="operator">(</span><span class="operator">)</span>
    ТоварСсылка <span class="operator">=</span> Справочники<span class="operator">.</span>Товары<span class="operator">.</span>НайтиПоКоду<span class="operator">(</span><span class="string">&quot;000000001&quot;</span><span class="operator">)</span><span class="operator">;</span>
    <span class="keyword">Попытка</span>
        ЗаблокироватьДанныеДляРедактирования<span class="operator">(</span>ТоварСсылка<span class="operator">)</span><span class="operator">;</span>
        <span class="comment">// Можно выполнять модификацию данных объекта</span>
        <span class="comment">// ...</span>
        ТоварОбъект <span class="operator">=</span> ТоварСсылка<span class="operator">.</span>ПолучитьОбъект<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
        ТоварОбъект<span class="operator">.</span>Наименование <span class="operator">=</span> <span class="string">&quot;Новое наименование&quot;</span><span class="operator">;</span>
        ТоварОбъект<span class="operator">.</span>Записать<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
        <span class="keyword">Возврат</span> <span class="keyword">Истина</span><span class="operator">;</span>
    <span class="keyword">Исключение</span>
        <span class="comment">// Нельзя модифицировать данные объекта</span>
        Сообщение <span class="operator">=</span> <span class="keyword">Новый</span> СообщениеПользователю<span class="operator">;</span>
        Сообщение<span class="operator">.</span>Текст <span class="operator">=</span> <span class="string">&quot;Данные объекта уже заблокированы&quot;</span><span class="operator">;</span>
        Сообщение<span class="operator">.</span>Сообщить<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
        <span class="keyword">Возврат</span> <span class="keyword">Ложь</span><span class="operator">;</span>
    <span class="keyword">КонецПопытки</span><span class="operator">;</span>
<span class="keyword">КонецФункции</span></pre>

<p class="MsoNormal">Следует помнить, что попытки установить блокировку одного и
того же объекта с указанием идентификатора формы и без указания идентификатора
несовместимы друг с другом.</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">ТоварСсылка <span class="operator">=</span> Справочники<span class="operator">.</span>Номенклатура<span class="operator">.</span>НайтиПоКоду<span class="operator">(</span><span class="number">1</span><span class="operator">)</span><span class="operator">;</span>
ЗаблокироватьДанныеДляРедактирования<span class="operator">(</span>ТоварСсылка<span class="operator">)</span><span class="operator">;</span>
<span class="keyword">Попытка</span>
    ЗаблокироватьДанныеДляРедактирования<span class="operator">(</span>ТоварСсылка<span class="operator">,</span> <span class="operator">,</span> ИдентФормы<span class="operator">)</span><span class="operator">;</span>
<span class="keyword">Исключение</span>
    <span class="comment">// исключение из-за несовместимости блокировок</span>
<span class="keyword">КонецПопытки</span><span class="operator">;</span></pre>

<p class="MsoNormal">Для снятия пессимистической блокировки разработчик может
использовать метод глобального контекста <span class="Term">РазблокироватьДанныеДляРедактирования()</span>.</p>

<a id="TI000000525" class="bookmark" name="issogl2_9.1.3_пессимистическая_блокировка_и_транзакции"><h3>9.1.3. Пессимистическая блокировка и транзакции</h3></a>

<p class="MsoNormalCxSpFirst">Операции блокировки объектов влияют только на выполнение
других операций блокировки объектов и не влияют на операции над данными и на
процесс течения транзакций.</p>

<p class="MsoNormalCxSpMiddle">Блокировка заблокированного объекта базы данных вызывает
исключение, которое может быть обработано и не приводит к обязательному откату
транзакции. Если в течение транзакции при выполнении метода <span class="Term">ЗаблокироватьДанныеДляРедактирования()</span>
возникло исключение, то оно может быть обработано конструкцией <span class="Term">Попытка … Исключение … КонецПопытки</span>
и не требует обязательного отката транзакции.</p>

<p class="MsoNormalCxSpLast">Блокировки объектов, установленные в течение транзакции,
снимаются при окончании транзакции, если блокировка устанавливалась без
указания идентификатора формы.</p>

<a id="TI000000526" class="bookmark" name="issogl2_9.1.4_оптимистическая_блокировка"><h3>9.1.4. Оптимистическая блокировка</h3></a>

<p class="MsoNormalCxSpFirst">Оптимистическая блокировка запрещает запись объекта
в базу данных, если после считывания объекта он был изменен в базе данных.</p>

<p class="MsoNormalCxSpMiddle">Строго говоря, оптимистическая блокировка
представляет собой проверку, которая выполняется перед записью объекта в базу
данных.</p>

<p class="MsoNormalCxSpMiddle">Когда объект встроенного языка считывает данные из
базы данных, в числе прочего считывается и версия объекта, хранящегося в базе
данных.</p>

<p class="MsoNormalCxSpMiddle">Если до начала редактирования данных пользователем
(до установки пессимистической блокировки) данные объекта в базе данных были
изменены (например, другим пользователем), то номер версии объекта, хранящийся
в базе данных, также изменится. При попытке пользователя записать этот объект
будет выполнена проверка соответствия версии объекта, находящегося в памяти, и
версии объекта, хранящейся в базе данных. Так как версии отличаются, будет
выдано предупреждение о том, что версия объекта изменилась или он был удален,
то есть сработает оптимистическая блокировка.</p>

<p class="MsoNormalCxSpLast">Оптимистическая блокировка гарантирует, что если
пользователь изменяет объект, то его изменения не «затрут» изменения, сделанные
другими сеансами или другими программными объектами этого же сеанса.</p>

<a id="TI000000527" class="bookmark" name="issogl1_9.2_механизм_транзакций"><h2>9.2. Механизм транзакций</h2></a>

<a id="TI000001741" class="bookmark" name="issogl2_9.2.1_общая_информация"><h3>9.2.1. Общая информация</h3></a>

<p class="MsoNormalCxSpFirst">Независимо от выбранного варианта работы (файловый
или клиент-серверный) система «1С:Предприятие» обеспечивает работу с
информацией, хранящейся в базе данных, с использованием механизма транзакций.</p>

<p class="MsoNormalCxSpMiddle"><span class="Bold">Транзакция</span> – это
неделимая с точки зрения воздействия на базу данных последовательность операций
манипулирования данными. Она выполняется по принципу «все или ничего» и
переводит базу данных из одного целостного состояния в другое целостное
состояние. Если по каким-либо причинам одно из действий транзакции невыполнимо
или произошло какое-либо нарушение работы системы, база данных возвращается в
то состояние, которое было до начала транзакции (происходит откат транзакции).</p>

<p class="MsoNormalCxSpMiddle">Транзакции могут использоваться как самой системой
«1С:Предприятие», так и разработчиком при написании модулей.</p>

<p class="MsoNormalCxSpMiddle">Система «1С:Предприятие» осуществляет неявный
вызов транзакций при выполнении любых действий, связанных с модификацией
информации, хранящейся в базе данных. Например, все обработчики событий,
расположенные в модулях объектов и наборов записей, связанные с модификацией данных
базы данных, вызываются в транзакции. В транзакции выполняется также чтение
объектов следующих типов: <span class="Term">ПланОбменаОбъект</span>, <span class="Term">ДокументОбъект</span>, <span class="Term">СправочникОбъект</span>,
<span class="Term">ПланВидовХарактеристикОбъект</span>,
<span class="Term">ПланВидовРасчетаОбъект</span>,
<span class="Term">ПланСчетовОбъект</span>,
<span class="Term">БизнесПроцессОбъект</span>,
<span class="Term">ЗадачаОбъект</span>,
<span class="Term">ПоследовательностьНаборЗаписей</span>,
<span class="Term">РегистрСведенийНаборЗаписей</span>,
<span class="Term">РегистрНакопленияНаборЗаписей</span>,
<span class="Term">РегистрБухгалтерииНаборЗаписей</span>,
<span class="Term">РегистрРасчетаНаборЗаписей</span>,
<span class="Term">ПерерасчетНаборЗаписей</span>.
При этом в режиме управляемых блокировок (см. <a href="#_ref253677585">здесь</a>) выполняется установка разделяемой блокировки по
значению регистратора для наборов записей и по значениям отбора для набора
записей независимого регистра сведений.</p>

<p class="MsoNormalCxSpLast">Наряду с этим разработчик может использовать работу
с транзакциями в явном виде. Для этого используются процедуры глобального
контекста <span class="Term">НачатьТранзакцию()</span>,
<span class="Term">ЗафиксироватьТранзакцию()</span>
и <span class="Term">ОтменитьТранзакцию()</span>.</p>

<a id="TI000000528" class="bookmark" name="issogl2_9.2.2_использование_явного_вызова_транзакций"><h3>9.2.2. Использование явного вызова транзакций</h3></a>

<p class="MsoNormalCxSpFirst">Метод <span class="Term">НачатьТранзакцию()</span> позволяет открыть транзакцию.
После этого все изменения информации базы данных, выполняемые последующими
операторами, могут быть либо целиком приняты, либо целиком отвергнуты.</p>

<p class="MsoNormalCxSpLast">Для принятия всех выполненных изменений используется
метод <span class="Term">ЗафиксироватьТранзакцию()</span>.
Для того чтобы отменить все изменения, выполнявшиеся в открытой транзакции,
используется метод <span class="Term">ОтменитьТранзакцию()</span>.
Если количество вызовов метода <span class="Term">НачатьТранзакцию()</span> превышает количество
вызовов методов <span class="Term">ЗафиксироватьТранзакцию()</span>
или <span class="Term">ОтменитьТранзакцию()</span>,
то система выполнит неявный вызов метода <span class="Term">ОтменитьТранзакцию()</span>
в следующих случаях:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
при окончании выполнения встроенного языка
(обработчик события, внешнее соединение, automation-сервер);</p>

<p class="MsoListBulletCxSpLast">&#9679; 
при передаче управления с сервера на клиента.</p>

<p class="MsoNormalCxSpFirst">Если количество вызовов методов <span class="Term">ЗафиксироватьТранзакцию()</span>
или <span class="Term">ОтменитьТранзакцию()</span>
превышает количество вызовов метода <span class="Term">НачатьТранзакцию()</span>, то при выполнении лишнего
вызова метода <span class="Term">ЗафиксироватьТранзакцию()</span>
или <span class="Term">ОтменитьТранзакцию()</span>
будет порождено исключение.</p>

<p class="MsoNormalCxSpLast">Таким образом, схема работы с транзакцией в общем виде
может выглядеть следующим образом:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="keyword">Попытка</span>
    НачатьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
    <span class="comment">// Последовательность операторов</span>
    …
    ЗафиксироватьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
<span class="keyword">Исключение</span>
    ОтменитьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
<span class="keyword">КонецПопытки</span><span class="operator">;</span></pre>

<p class="MsoNormalCxSpFirst">При использовании такой схемы следует помнить о
том, что не все ошибки, возникающие при работе с базой данных, обрабатываются
системой одинаково.</p>

<p class="MsoNormalCxSpLast">В общем случае все ошибки базы данных можно разделить
на две категории:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
невосстановимые,</p>

<p class="MsoListBulletCxSpLast">&#9679; 
восстановимые.</p>

<p class="MsoNormalCxSpFirst"><span class="Bold">Невосстановимые ошибки</span> –
это ошибки, при возникновении которых нормальное функционирование системы «1С:Предприятие»
может быть нарушено, например, могут быть испорчены данные. При возникновении
невосстановимой ошибки выполнение системы «1С:Предприятие» прекращается в любом
случае.</p>

<p class="MsoNormalCxSpMiddle">Если невосстановимая ошибка произошла в процессе
выполнения транзакции, то все изменения, сделанные в рамках этой транзакции,
отменяются системой.</p>

<p class="MsoNormalCxSpMiddle"><span class="Bold">Восстановимые ошибки</span> –
это ошибки, не вызывающие серьезных нарушений в работе системы «1С:Предприятие».
В случае возникновения восстановимой ошибки дальнейшая работа системы может
быть продолжена. При этом, естественно, сама операция, вызвавшая ошибку,
прекращается, и вызывается исключение, которое может быть перехвачено и
обработано конструкцией <span class="Term">Попытка … Исключение … КонецПопытки</span>.</p>

<p class="MsoNormalCxSpMiddle">Если восстановимая ошибка произошла в процессе выполнения
транзакции, то система автоматически не выполняет отмену транзакции,
предоставляя разработчику возможность самостоятельно обработать сложившуюся
ситуацию.</p>

<p class="MsoNormalCxSpMiddle">В зависимости от характера произошедшей ошибки возможны
различные сценарии обработки этой ситуации.</p>

<p class="MsoNormalCxSpMiddle">Если произошедшая ошибка не связана с базой
данных, то возможно продолжение транзакции и дальнейшей работы модуля. Если
разработчик считает это необходимым, он может отменить транзакцию или,
наоборот, продолжить выполнение транзакции, если произошедшая ошибка не нарушает
атомарность транзакции.</p>

<p class="MsoNormalCxSpMiddle">Если же исключительная ситуация была вызвана ошибкой
базы данных, то система фиксирует факт возникновения ошибки в этой транзакции,
и дальнейшее продолжение транзакции или ее фиксация становятся невозможны.
Единственная операция с базой данных, которую разработчик может произвести в
данной ситуации, – это отмена транзакции. После этого он может осуществить
попытку выполнения этой транзакции еще раз.</p>

<p class="MsoNormalCxSpLast">Например, фрагмент кода, реализующий этот подход при
записи некоторых данных в базу данных, может выглядеть следующим образом.</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// Признак окончания попыток выполнения записи</span>
Записано <span class="operator">=</span> <span class="keyword">Ложь</span><span class="operator">;</span>
<span class="comment">// Попытки записи выполняются в цикле</span>
<span class="keyword">Пока</span> <span class="keyword">Не</span> Записано <span class="keyword">Цикл</span>
    <span class="keyword">Попытка</span>
        НачатьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
        Данные<span class="operator">.</span>Записать<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
        ЗафиксироватьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
        <span class="comment">// В случае фиксации транзакции прекратить попытки записи</span>
        Записано <span class="operator">=</span> <span class="keyword">Истина</span><span class="operator">;</span>
    <span class="keyword">Исключение</span>
        <span class="comment">// В случае неудачи отменить текущую транзакцию и</span>
        <span class="comment">// следующую попытку начать с новой транзакции</span>
        ОтменитьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
    <span class="keyword">КонецПопытки</span><span class="operator">;</span>
<span class="keyword">КонецЦикла</span><span class="operator">;</span></pre>

<a id="TI000000529" class="bookmark" name="issogl2_9.2.3_вложенный_вызов_транзакций"><h3>9.2.3. Вложенный вызов транзакций</h3></a>

<p class="MsoNormal">В рамках уже выполняемой транзакции можно обращаться к
процедурам <span class="Term">НачатьТранзакцию()</span>,
<span class="Term">ЗафиксироватьТранзакцию()</span>
и <span class="Term">ОтменитьТранзакцию()</span>.
Например, может использоваться следующая схема вызовов:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">НачатьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
…
    <span class="comment">// Вложенный вызов транзакции</span>
    НачатьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
    …
    ЗафиксироватьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
…
    <span class="comment">// Вложенный вызов транзакции</span>
    НачатьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
    …
    ЗафиксироватьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
…
ЗафиксироватьТранзакцию<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="MsoNormal">Однако подобное обращение не означает начала новой транзакции
в рамках уже выполняющейся.</p>

<p class="Note"><span class="Note">ВНИМАНИЕ!</span> Система «1С:Предприятие»
не поддерживает вложенных транзакций.</p>

<p class="MsoNormal">Это означает, что всегда действует только транзакция самого
верхнего уровня. Все транзакции, вызванные внутри уже открытой транзакции,
фактически относятся к той же транзакции, а не образуют вложенную транзакцию.
Таким образом, отмена изменений, выполняемая во вложенной транзакции, будет приводить
в конечном счете не к отмене изменений самой вложенной транзакции, а к отмене
всех изменений транзакции верхнего уровня. В то же время фиксация изменений,
выполненная во вложенной транзакции, игнорируется.</p>

<a id="TI000000530" class="bookmark" name="issogl2_9.2.4_влияние_транзакций_на_работу_программных_объектов"><h3>9.2.4. Влияние транзакций на работу программных объектов</h3></a>

<p class="MsoNormalCxSpFirst">В общем случае программные объекты, используемые
системой «1С:Предприятие», абсолютно «прозрачны» для транзакций базы данных.
Иначе говоря, транзакции базы данных могут вызываться при выполнении различных
методов программных объектов, однако, например, действия, выполняемые базой
данных при откате транзакции, в общем случае никак не влияют на соответствующие
программные объекты.</p>

<p class="MsoNormalCxSpMiddle">Из этого следует, что при отмене транзакций базы
данных разработчик (если в этом есть необходимость) должен самостоятельно
обеспечивать адекватное изменение данных соответствующих программных объектов.
Это можно выполнять путем повторного чтения всех данных объекта или путем изменения
некоторых реквизитов программного объекта (если, например, это необходимо для
отображения в интерфейсе).</p>

<p class="MsoNormalCxSpLast">В этом правиле есть исключения. В силу значительной
прикладной специфики программных объектов системы «1С:Предприятие» в некоторых
случаях откат изменений, выполненных в базе данных, все же может влиять на
значения свойств соответствующих программных объектов. Это происходит в следующих
случаях:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
при отмене транзакции признак проведения документа
восстанавливает значение, которое было до начала транзакции;</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
если объект был создан и записан в транзакции,
то при откате транзакции очищается значение ссылки;</p>

<p class="MsoListBulletCxSpLast">&#9679; 
если объект создавался вне транзакции и при
записи его в транзакции использовался код/номер, сгенерированный автоматически,
то при отмене транзакции код/номер очищается.</p>

<a name="_ref253677585"></a><a name="_ref380766353"></a><a id="TI000000531" class="bookmark" name="issogl1_9.3_механизм_управляемых_блокировок"><h2>9.3. Механизм управляемых блокировок</h2></a>

<a id="TI000000532" class="bookmark" name="issogl2_9.3.1_общая_информация"><h3>9.3.1. Общая информация</h3></a>

<p class="MsoNormalCxSpFirst">В
идеальном случае в любой СУБД транзакции должны обеспечивать изоляцию
изменений, выполняемых в базе данных. Иными словами, несколько транзакций, выполняющих
изменение данных, не должны мешать друг другу.</p>

<p class="MsoNormalCxSpMiddle">Самым
простым способом решения этой проблемы является последовательное выполнение
транзакций. Следующая транзакция выполняется после того, как закончилась предыдущая.</p>

<p class="MsoNormalCxSpMiddle">Однако в
реальной ситуации, при многопользовательской работе, такой подход приводит к
резкому снижению производительности системы. Поэтому на практике используются
механизмы, позволяющие выполнять несколько транзакций одновременно.</p>

<p class="MsoNormalCxSpMiddle">Для того
чтобы одновременное выполнение транзакций стало возможным, используется
несколько уровней изоляции транзакций. На самом низком уровне изоляции транзакции
могут сильно влиять друг на друга. На самом высоком уровне они полностью изолированы.</p>

<p class="MsoNormalCxSpMiddle">Таким
образом, за большую изоляцию транзакций приходится платить большими накладными
расходами и замедлением работы системы.</p>

<p class="MsoNormalCxSpMiddle">Возможность
изоляции одних транзакций от других обычно реализуется благодаря блокировкам,
накладываемым на используемые ими данные. В зависимости от уровня изоляции
накладываются различные типы блокировок на различные объекты базы данных, на
различное время.</p>

<p class="MsoNormalCxSpLast">С точки
зрения системы «1С:Предприятие» работа с данными может выполняться в одном из
двух режимов:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
в транзакции,</p>

<p class="MsoListBulletCxSpLast">&#9679; 
вне транзакции.</p>

<p class="MsoNormalCxSpFirst">Режим
работы с данными <span class="Bold">вне транзакции</span> допускает только
операции <span class="Bold">чтения данных</span>. Этот режим введен для того,
чтобы обеспечить максимальную скорость и параллельность чтения данных. Поэтому
любая операция чтения данных, выполняемая вне транзакции, считается <span class="Bold">безответственной</span>. Это означает, что такая операция чтения
может вернуть устаревшие данные или даже незафиксированные изменения, произведенные
другой транзакцией, т. е. чтение выполняется «не глядя» на блокировки
данных, расставленные другими транзакциями.</p>

<p class="MsoNormalCxSpMiddle">Режим
работы с данными в транзакции допускает любые операции чтения и модификации
данных.</p>

<p class="MsoNormalCxSpLast">При этом
должны соблюдаться следующие правила:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
Чтение данных должно быть воспроизводимым, т. е.
любая последующая операция чтения данных с тем же условием выборки должна
возвращать такой же результат.</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
Результат чтения должен содержать наиболее актуальные
данные. Это означает, что никакая другая транзакция не может изменить данные,
считанные в данной транзакции, до тех пор, пока данная транзакция не будет
завершена.</p>

<p class="MsoListBulletCxSpLast">&#9679; 
Результат чтения не должен содержать незафиксированные
изменения данных базы данных.</p>

<a name="_ref369771576"></a><a name="_ref369771575"></a><a name="_ref322594750"></a><a name="_ref322594749"></a><a name="_ref215985904"></a><a id="TI000000533" class="bookmark" name="issogl2_9.3.2_управляемые_блокировки"><h3>9.3.2. Управляемые блокировки</h3></a>

<p class="MsoNormalCxSpFirst">Система «1С:Предприятие»
позволяет использовать два режима работы с базой данных в рамках транзакции:
режим автоматических блокировок и режим управляемых блокировок.</p>

<p class="MsoNormalCxSpMiddle">Принципиальное
отличие этих режимов заключается в следующем. Режим автоматических блокировок
не требует от разработчика каких-либо действий по управлению блокировками в
транзакции для того, чтобы обеспечивались перечисленные выше правила работы с
данными в транзакции. Эти правила обеспечиваются платформой системы «1С:Предприятие»
за счет использования определенных уровней изоляции транзакций в той или иной
СУБД. Такой режим работы является наиболее простым для разработчика, однако в
некоторых случаях (например, при интенсивной одновременной работе большого
количества пользователей) используемый уровень изоляции транзакций в СУБД не может
обеспечить достаточной параллельности работы, что проявляется в виде большого
количества конфликтов блокировок при работе пользователей.</p>

<p class="MsoNormalCxSpLast">При работе
в режиме управляемых блокировок система «1С:Предприятие» использует гораздо
более низкий уровень изоляции транзакций в СУБД, что позволяет значительно повысить
параллельность работы пользователей прикладного решения. Однако, в отличие от
режима автоматических блокировок, данный уровень изоляции транзакций уже не
может сам по себе обеспечить выполнение всех правил работы с данными в
транзакции (в частности, не обеспечивается воспроизводимость чтения данных в
транзакции). Поэтому при работе в управляемом режиме от разработчика требуется
самостоятельно управлять блокировками, устанавливаемыми в транзакции.</p>

<p class="Regularbeforetable">В сводном виде отличия при работе в режиме автоматических
блокировок и в режиме управляемых блокировок приведены в следующей таблице:</p>

<table class="MsoNormalTable" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpFirst"><b> </b></p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Вид<br>
  блокировки</b></p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Уровень<br>
  изоляции транзакций</b></p>
  </td>
  
 </tr>
 <tr>
  <td colspan="3" valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Bold">Автоматические блокировки</span></p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Файловая БД</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Таблиц</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Serializable</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">MS SQL Server</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Repetable Read или Serializable</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">IBM DB2</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Repetable Read или Serializable</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">PostgreSQL</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Таблиц</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Serializable</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Oracle Database</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Таблиц</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Serializable</p>
  </td>
  
 </tr>
 <tr>
  <td colspan="3" valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Bold">Управляемые блокировки</span></p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Файловая БД</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Таблиц</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Serializable</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">MS SQL Server 2000</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Read Commited</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">MS SQL Server 2005<br>
  и выше</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Read Commited Snapshot</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">IBM DB2</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Read Commited</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">PostgreSQL</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Read Commited</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Oracle Database</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Записей</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Read Commited</p>
  </td>
  
 </tr>
</table>

<p class="Note">Примечание. Рекомендуется
разработку прикладных решений вести в режиме управляемых блокировок с целью
максимального использования возможностей СУБД. Использование прикладного
решения в автоматическом режиме используется для совместимости с предыдущими
версиями прикладных решений и не рекомендуется для реальной эксплуатации.</p>

<p class="Regularbeforetable">Поведение
системы при безответственном чтении (например, при работе динамических списков,
выполнении отчетов) также отличается в различных режимах блокировок. В сводном
виде отличия безответственного чтения в разных режимах работы блокировок
(автоматическом или управляемом) приведены в следующей таблице:</p>

<table class="MsoNormalTable" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpFirst"><b> </b></p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Чтение<br>
  вне транзакции</b></p>
  </td>
  
 </tr>
 <tr>
  <td colspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Bold">Автоматические блокировки</span></p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Файловая БД</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">«Грязное»
  чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">MS SQL Server</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">«Грязное» чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">IBM DB2</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">«Грязное» чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">PostgreSQL</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Согласованное
  чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Oracle Database</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Согласованное чтение</p>
  </td>
  
 </tr>
 <tr>
  <td colspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Bold">Управляемые блокировки</span></p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Файловая БД</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">«Грязное» чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">MS SQL Server 2000</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">«Грязное»
  чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">MS SQL Server 2005<br>
  и выше</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Согласованное чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">IBM DB2 до
  версии 9.7</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">«Грязное»
  чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">IBM DB2 версии 9.7 и выше</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Согласованное чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">PostgreSQL</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Согласованное
  чтение</p>
  </td>
  
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Oracle Database</p>
  </td>
  
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Согласованное чтение</p>
  </td>
  
 </tr>
</table>

<a id="TI000000534" class="bookmark" name="issogl2_9.3.3_установка_режима_блокировок_в_конфигурации"><h3>9.3.3. Установка режима блокировок в конфигурации</h3></a>

<p class="MsoNormalCxSpFirst"><span class="Interface">Конфигурация</span> имеет
свойство <span class="Interface">Режим управления блокировкой данных</span>.
Каждый прикладной объект конфигурации также имеет свойство <span class="Interface">Режим управления блокировкой данных</span>.</p>

<p class="MsoNormalCxSpMiddle">Режим управления блокировкой данных для всей конфигурации
в целом может быть установлен в значения <span class="Interface">Автоматический</span>,
<span class="Interface">Управляемый</span> (установлено по умолчанию для новой
конфигурации) и <span class="Interface">Автоматический и управляемый</span>. Значения
<span class="Interface">Автоматический</span> и <span class="Interface">Управляемый</span>
означают, что соответствующий режим блокировки будет использоваться для всех
объектов конфигурации, независимо от значений, установленных для каждого из объектов.
Значение <span class="Interface">Автоматический и управляемый</span> означает,
что для конкретного объекта конфигурации будет использован тот режим, который
указан в его свойстве <span class="Interface">Режим управления блокировкой данных</span>:
<span class="Interface">Автоматический</span> или <span class="Interface">Управляемый</span>.</p>

<p class="MsoNormalCxSpMiddle">Следует отметить, что режим управления блокировкой
данных, указанный для объекта метаданных, устанавливается для тех транзакций,
которые инициируются системой «1С:Предприятие» при работе с данными этого
объекта (например, при модификации данных объекта).</p>

<p class="MsoNormalCxSpMiddle">Если же, например, операция записи объекта
выполняется в транзакции, инициированной разработчиком (метод <span class="Term">НачатьТранзакцию()</span>),
то режим управления блокировкой данных будет определяться значением параметра <span class="Term">РежимБлокировок</span>
метода <span class="Term">НачатьТранзакцию()</span>,
а не значением свойства объекта метаданных <span class="Interface">Режим
управления блокировкой данных</span>.</p>

<p class="MsoNormalCxSpLast">По умолчанию параметр <span class="Term">РежимБлокировок</span>
имеет значение <span class="Term">РежимУправленияБлокировкойДанных.Автоматический</span>,
поэтому для того, чтобы в явной транзакции использовать режим управляемых
блокировок, следует указывать значение этого параметра <span class="Term">РежимУправленияБлокировкойДанных.Управляемый</span>.</p>

<a name="_ref360014091"></a><a name="_ref360014090"></a><a name="_ref346820131"></a><a name="_ref346820130"></a><a name="_ref381270741"></a><a name="_ref381270740"></a><a name="_ref380681689"></a><a id="TI000000535" class="bookmark" name="issogl2_9.3.4_работа_с_управляемыми_блокировками_средствами_встроенного_языка"><h3>9.3.4. Работа с управляемыми блокировками средствами встроенного языка</h3></a>

<p class="MsoNormalCxSpFirst">Для управления блокировками в транзакции предназначен
объект встроенного языка <span class="Term">БлокировкаДанных</span>. Экземпляр этого объекта
может быть создан с помощью конструктора и позволяет описать необходимые пространства
блокировок и режимы блокировок. Для установки всех созданных блокировок
используется метод <span class="Term">Заблокировать()</span>
объекта <span class="Term">БлокировкаДанных</span>.
Если этот метод выполняется в транзакции (явной или неявной), блокировки
устанавливаются и при окончании транзакции будут сняты автоматически. Если метод
<span class="Term">Заблокировать()</span>
выполняется вне транзакции или в автоматическом режиме управления блокировками
в рамках транзакции, то будет сгенерировано исключение.</p>

<p class="MsoNormalCxSpLast">Объект <span class="Term">БлокировкаДанных</span> представляет собой коллекцию
элементов блокировки данных, каждый из которых описывает блокировки одного
пространства блокировок. Пространства блокировок определены в платформе системы
«1С:Предприятие» и соответствуют структуре прикладных объектов конфигурации.
Для каждого пространства блокировок в платформе определены имена полей,
значения которых могут анализироваться при установке тех или иных блокировок.</p>

<p class="Regularbeforetable">Допустимы следующие имена пространств блокировок и
имена полей пространств блокировок:</p>

<table class="MsoNormalTable" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpFirst"><b>Имя<br>
  пространства блокировки</b></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Имя поля<br>
  пространства блокировки</b></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Справочник.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Документ.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ПланОбмена.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ПланСчетов.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">БизнеcПроцесс.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Задача.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ПланВидовРасчета.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ПланВидовХарактеристик.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  поля&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрСведений.&lt;имя&gt;.НаборЗаписей</span> –
  только для регистра сведений, подчиненного регистратору</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Регистратор</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрСведений.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Период –
  если есть;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  измерения&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрНакопления.&lt;имя&gt;.НаборЗаписей</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Регистратор</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрНакопления.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Период</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  измерения&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрБухгалтерии.&lt;имя&gt;.НаборЗаписей</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Регистратор</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрБухгалтерии.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Период</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  измерения&gt;</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;вид
  движения&gt;</span> – значение системного перечисления<span class="Term">
  ВидДвиженияБухгалтерии</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">Счет</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">Субконто&lt;N&gt;</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;вид
  субконто&gt;.</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрРасчета.&lt;имя&gt;.НаборЗаписей</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Регистратор</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">РегистрРасчета.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ПериодРегистрации</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">ПериодДействия</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  измерения&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Перерасчет.&lt;имя&gt;.НаборЗаписей</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ОбъектПерерасчета</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Последовательность.&lt;имя&gt;.НаборЗаписей</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Регистратор</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Последовательность.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя
  измерения&gt;</span></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Константа.&lt;имя&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"> </p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">ВнешнийИсточникДанных.&lt;имя
  источника&gt;.Таблица.&lt;имя таблицы&gt;</span></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><span class="Term">Ссылка</span>;</p>
  <p class="MsoNormalCxSpMiddle"><span class="Term">&lt;имя поля&gt;</span></p>
  </td>
 </tr>
</table>

<p class="MsoNormalCxSpLast">Где <span class="Term">&lt;имя поля&gt;</span> – имя поля, по которому
может быть установлена управляемая блокировка. Перечень допустимых полей (по
которым может быть установлена управляемая блокировка) задается в свойстве <span class="Interface">Поля блокировки данных</span> для следующих объектов:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
справочники,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
документы,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
планы видов характеристик,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
планы счетов,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
планы видов расчета,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
планы обмена,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
бизнес-процессы,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
задачи;</p>

<p class="MsoListBulletCxSpLast">&#9679; 
таблицы внешних источников данных.</p>

<p class="MsoNormalCxSpFirst">Запрещено устанавливать блокировки по реквизитам (и
общим реквизитам) следующих типов: строка неограниченной длины, хранилище
значения, тип значения плана видов характеристик, составной тип, включающий
один из вышеперечисленных типов. Запрет относится к следующим объектам:
справочники, документы, планы видов характеристик, планы видов расчета, планы
счетов, бизнес-процессы, задачи, планы обмена. Также запрещено устанавливать
блокировки по полям <span class="Term">Предопределенный</span>
и <span class="Term">ИмяПредопределенныхДанных</span>
в справочниках, планах видов характеристик, планах видов расчета, планах счетов.</p>

<p class="MsoNormalCxSpMiddle">При установке управляемой транзакционной
блокировки на пространство <span class="Term">РегистрБухгалтерии.&lt;Имя&gt;</span>, если значение
субконто задано ссылкой на характеристику, то в плане счетов эта характеристика
должна быть одним из субконто этого счета. Если соответствующее субконто у
счета не задано, то будет выдана ошибка.</p>

<p class="MsoNormalCxSpLast">Для каждого пространства блокировки может быть задано
произвольное количество условий на поля, по которым будут определяться записи,
подлежащие блокировке. Условия задаются на равенство значения поля указанному
значению или на вхождение значения поля в указанный диапазон. Условия могут
быть заданы двумя способами:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
с помощью явного указания имени поля и значения
(метод <span class="Term">УстановитьЗначение()</span>
объекта <span class="Term">ЭлементБлокировкиДанных</span>);</p>

<p class="MsoListBulletCxSpLast">&#9679; 
с помощью указания источника данных, содержащего
необходимые значения (свойство <span class="Term">ИсточникДанных</span> объекта <span class="Term">ЭлементБлокировкиДанных</span>).</p>

<p class="MsoNormal">При явном указании значения поля в параметры метода <span class="Term">УстановитьЗначение()</span>
передается имя поля и значение:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">Блокировка <span class="operator">=</span> <span class="keyword">Новый</span> БлокировкаДанных<span class="operator">;</span>
ЭлементБлокировки <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;Справочник.Магазин&quot;</span><span class="operator">)</span><span class="operator">;</span>
ЭлементБлокировки<span class="operator">.</span>УстановитьЗначение<span class="operator">(</span><span class="string">&quot;Код&quot;</span><span class="operator">,</span> <span class="number">100</span><span class="operator">)</span><span class="operator">;</span>
ЭлементБлокировки<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Исключительный<span class="operator">;</span>
Блокировка<span class="operator">.</span>Заблокировать<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
Блокировка <span class="operator">=</span> <span class="keyword">Новый</span> БлокировкаДанных<span class="operator">;</span>
ЭлементБлокировки <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыНаСкладах&quot;</span><span class="operator">)</span><span class="operator">;</span>
ЭлементБлокировки<span class="operator">.</span>УстановитьЗначение<span class="operator">(</span><span class="string">&quot;Качество&quot;</span><span class="operator">,</span> Справочники<span class="operator">.</span>Качество<span class="operator">.</span>НайтиПоКоду<span class="operator">(</span><span class="string">&quot;1&quot;</span><span class="operator">)</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="MsoNormalCxSpFirst">Следует иметь в виду, что одну и ту же запись
регистра можно заблокировать дважды: первый раз блокируя саму запись, а второй
раз – блокируя набор, в который эта запись входит.</p>

<p class="MsoNormalCxSpMiddle">При удалении или изменении объекта, для которого
доступна блокировка по полям, выполняется блокировка по полю <span class="Term">Ссылка</span> и по всем
полям, указанным в свойстве <span class="Interface">Поля блокировки данных</span>.
При выполнении изменения объект блокируется как по «старым» значениям полей
(которые были до начала записи), так и по «новым» значениям (которые находятся
в записываемом объекте).</p>

<p class="MsoNormalCxSpMiddle">В качестве значения может быть передан также
объект встроенного языка <span class="Term">Диапазон</span>, который создается с помощью конструктора
и позволяет задать верхнюю и нижнюю границы диапазона (границы диапазона
включаются в диапазон).</p>

<p class="MsoNormalCxSpLast">При использовании источника данных устанавливается
значение свойства <span class="Term">ИсточникДанных</span>,
а затем с помощью метода <span class="Term">ИспользоватьИзИсточникаДанных()</span> задается соответствие
полей области блокировки полям источника данных:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">Блокировка <span class="operator">=</span> <span class="keyword">Новый</span> БлокировкаДанных<span class="operator">;</span>
ЭлементБлокировки <span class="operator">=</span> Блокировка<span class="operator">.</span> Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыНаСкладах&quot;</span><span class="operator">)</span><span class="operator">;</span>
ЭлементБлокировки<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>ВозвратнаяТара<span class="operator">;</span>
ЭлементБлокировки<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span> <span class="string">&quot;Номенклатура&quot;</span><span class="operator">)</span><span class="operator">;</span>
ЭлементБлокировки<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Склад&quot;</span><span class="operator">,</span> <span class="string">&quot;Склад&quot;</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="MsoNormal">В качестве источника данных может выступать:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
результат запроса,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
табличная часть,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
набор записей,</p>

<p class="MsoListBulletCxSpLast">&#9679; 
таблица значений.</p>

<p class="MsoNormal">Соответственно, при установке соответствия полей именами
полей источника будут являться:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
имена колонок результата запроса,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
имена реквизитов табличной части,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
имена измерений,</p>

<p class="MsoListBulletCxSpLast">&#9679; 
имена колонок таблицы значений.</p>

<p class="MsoNormalCxSpFirst">Объект <span class="Term">Диапазон</span> также может являться значением поля
источника данных.</p>

<p class="MsoNormalCxSpLast">Для каждого элемента блокировки может быть задан
один из двух режимов блокировки:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
разделяемый,</p>

<p class="MsoListBulletCxSpLast">&#9679; 
исключительный.</p>

<p class="MsoNormal">Режим блокировки задается с помощью свойства <span class="Term">Режим</span>
объекта <span class="Term">ЭлементБлокировкиДанных</span>.</p>

<p class="Regularbeforetable">Таблица совместимости управляемых блокировок выглядит
следующим образом:</p>

<table class="MsoNormalTable" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpFirst"> </p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Разделяемая</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Исключительная</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Разделяемая</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Исключительная</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
</table>

<p class="MsoNormalCxSpMiddle">Разделяемый режим блокировки подразумевает, что заблокированные
данные не могут быть изменены другой транзакцией до окончания текущей
транзакции.</p>

<p class="MsoNormalCxSpMiddle">Исключительный режим блокировки подразумевает, что
заблокированные данные не могут быть изменены другой транзакцией до окончания
текущей транзакции, а также не могут быть прочитаны другой транзакцией, устанавливающей
разделяемую блокировку на эти данные.</p>

<p class="MsoNormalCxSpLast">Говоря о совместимости действий, выполняемых в транзакции,
следует учитывать, что помимо явных управляемых блокировок, устанавливаемых
пользователем, система «1С:Предприятие» устанавливает также неявные управляемые
исключительные блокировки при записи данных в транзакции. При чтении данных
объекта из базы данных (получении объекта и обращении к ссылке) не выполняется
транзакционная блокировка объекта. Если блокировка необходима, то ее нужно
устанавливать средствами языка до обращения к объекту.</p>

<p class="Regularbeforetable">Таким образом, таблица совместимости действий, выполняемых
в транзакции при использовании режима управляемых блокировок, выглядит
следующим образом.</p>

<table class="MsoNormalTable" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td rowspan="2" valign="top">
  <p class="MsoNormalCxSpFirst"><b>Блоки–ровка</b></p>
  </td>
  <td rowspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Реж–им</b></p>
  </td>
  <td colspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle"><b>ББ</b></p>
  </td>
  <td colspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle"><b>РБ</b></p>
  </td>
  <td colspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle"><b>ИБ</b></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">R</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">W</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">R</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">W</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">R</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">W</p>
  </td>
 </tr>
 <tr>
  <td rowspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle">ББ</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">R</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">W</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
 <tr>
  <td rowspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle">РБ</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">R</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">W</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
 <tr>
  <td rowspan="2" valign="top">
  <p class="MsoNormalCxSpMiddle">ИБ</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">R</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">W</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">+</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">-</p>
  </td>
 </tr>
</table>

<p class="Regularbeforetable"></a><a name="_toc167778689">Где:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
R – чтение,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
W – запись,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
ББ – без блокировки,</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
РБ – разделяемая блокировка,</p>

<p class="MsoListBulletCxSpLast">&#9679; 
ИБ – исключительная блокировка.</p>

<a id="TI000000536" class="bookmark" name="issogl2_9.3.5_особенности_работы_в_режиме_автоматический_и_управляемый"><h3>9.3.5. Особенности работы в режиме «Автоматический и управляемый»</h3></a>

<p class="MsoNormalCxSpFirst">Режим управления блокировками <span class="Interface">Автоматический и управляемый</span> предназначен для решения
проблем, возникающих при параллельной работе с отдельными объектами конфигурации.</p>

<p class="MsoNormalCxSpMiddle">Например, существует большая конфигурация, которую
сложно в один момент перевести в режим управляемых блокировок, однако есть один
или два документа, являющиеся «камнем преткновения» при одновременной работе с
ними большого количества пользователей. В этом случае вся конфигурация может
быть переведена в режим <span class="Interface">Автоматический и управляемый</span>,
а затем сам документ и затрагиваемые при его записи объекты конфигурации –
в режим <span class="Interface">Управляемый</span>. Это позволит настроить работу
с данным документом в режиме управляемых блокировок, в то время как основная
часть конфигурации будет продолжать функционировать в автоматическом режиме
управления блокировками.</p>

<p class="MsoNormalCxSpLast">При работе в режиме управления блокировками <span class="Interface">Автоматический и управляемый</span> следует учитывать две особенности:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
Независимо от режима, указанного для данной транзакции,
система будет устанавливать соответствующие управляемые блокировки.</p>

<p class="MsoListBulletCxSpLast">&#9679; 
Режим управления блокировками определяется транзакцией
самого «верхнего» уровня. Другими словами, если к моменту начала транзакции
была начата другая транзакция, то начинаемая транзакция может быть выполнена
только в том в режиме, который установлен для уже выполняющейся транзакции.</p>

<p class="MsoNormalCxSpFirst">Рассмотрим перечисленные особенности более
подробно.</p>

<p class="MsoNormalCxSpMiddle">Первая особенность заключается в том, что даже
если для транзакции используется автоматический режим управления блокировками,
система установит дополнительно и соответствующие управляемые блокировки при
записи данных в этой транзакции. Из этого следует, что транзакции, исполняющиеся
в режиме управляемых блокировок, могут конфликтовать с транзакциями, исполняющимися
в режиме автоматического управления блокировками.</p>

<p class="MsoNormalCxSpMiddle">Вторая особенность заключается в том, что режим
управления блокировками, указываемый для объекта метаданных в конфигурации или
указываемый при начале транзакции в явном виде (как параметр метода <span class="Term">НачатьТранзакцию()</span>),
является лишь «желаемым» режимом. Фактический режим управления блокировками, в
котором будет исполняться транзакция, зависит от того, является ли данный вызов
начала транзакции первым, или к этому моменту уже начата другая транзакция в
данной сессии системы «1С:Предприятие».</p>

<p class="MsoNormalCxSpLast">Например, если требуется управлять блокировками при
записи наборов записей регистра, при проведении документа, то управляемый режим
блокировок должен быть установлен как для самого регистра, так и для документа,
поскольку запись наборов записей регистра будет выполняться в транзакции,
открытой при записи документа.</p>

<p class="Regularbeforetable">Возможны четыре различных сочетания режимов управления
блокировками в транзакции, которые представлены в следующей таблице:</p>

<table class="MsoNormalTable" border="0" cellspacing="0" cellpadding="0">
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpFirst"><b>Режим<br>
  существующей<br>
  транзакции</b></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Режим<br>
  начинаемой<br>
  транзакции</b></p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle"><b>Результат</b></p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Автоматический</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Автоматический</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Начинаемая
  транзакция будет выполнена в автоматическом режиме</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Автоматический</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Управляемый</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Начинаемая
  транзакция будет выполнена в автоматическом режиме</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Управляемый</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Автоматический</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Будет
  вызвана исключительная ситуация</p>
  </td>
 </tr>
 <tr>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Управляемый</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Управляемый</p>
  </td>
  <td valign="top">
  <p class="MsoNormalCxSpMiddle">Начинаемая
  транзакция будет выполнена в управляемом режиме</p>
  </td>
 </tr>
</table>

<a name="_ref338764670"></a><a name="_ref449003404"></a><a name="_ref449003403"></a><a id="TI000000537" class="bookmark" name="issogl2_9.3.6_особенности_работы_с_большим_количеством_управляемых_блокировок"><h3>9.3.6. Особенности работы с большим количеством управляемых блокировок</h3></a>

<p class="MsoNormal">Следует
помнить, что если на одно пространство накладывается более 100 000
блокировок, то может произойти эскалация блокировки. При эскалации блокировки
блокируется все пространство. При использовании независимых разделителей эскалация
происходит для одного набора значений разделителей:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
Блокируется все пространство только в рамках
значений разделителей;</p>

<p class="MsoListBulletCxSpLast">&#9679; 
На сеансы с другими значениями разделителей
эскалация влияния не оказывает.</p>

<p class="MsoNormalCxSpFirst">При
работе с управляемыми блокировками следует помнить о том, что система может
поглощать устанавливаемые блокировки. Блокировка, в которой указаны значения не
всех пространств блокировки, поглотит блокировку, в которой указаны значения
для большего количества пространств блокировки, при условии, что совпадают
значения по совпадающим пространствам блокировок. Поглощаться могут как
блокировки, устанавливаемые из встроенного языка с помощью метода <span class="Term">БлокировкаДанных.Заблокировать()</span>, так и
блокировки, устанавливаемые механизмами платформы.</p>

<p class="MsoNormalCxSpMiddle">Так,
например, если регистр накопления имеет измерения <span class="Term">Склад</span> и <span class="Term">Номенклатура</span>, то блокировка, у которой указано
только измерение <span class="Term">Склад</span>,
поглотит любые блокировки, у которых указаны оба измерения (<span class="Term">Склад</span> и <span class="Term">Номенклатура</span>).</p>

<p class="MsoNormalCxSpMiddle">В
случае если используется транзакция с больш<span class="Bold">и</span>м
количеством управляемых блокировок, которые отличаются, например, значением
одного измерения, рекомендуется вместо большого количества блокировок
установить одну управляемую блокировку, для которой не будет установлено
значение отличающегося измерения.</p>

<p class="MsoNormalCxSpLast">Если
при эскалации блокировки возникает конфликт с уже наложенными блокировками, то
эскалация не выполняется, а производится попытка установить запрошенную
блокировку. В этом случае возможна ситуация, когда в системе будет существовать
более 100 000 блокировок на одно пространство.</p>

<a id="TI000000538" class="bookmark" name="issogl2_9.3.7_модификация_конфигураций_при_переходе_к_режиму_управляемых_блокировок"><h3>9.3.7. Модификация конфигураций при переходе к режиму управляемых блокировок</h3></a>

<a id="TI000001835" class="bookmark" name="issogl3_9.3.7.1_общая_информация"><h4>9.3.7.1. Общая информация</h4></a>

<p class="MsoNormal">При переходе к частичной или полной работе в режиме
управляемых блокировок прикладное решение требует доработки. Доработка
заключается в том, что необходимо выявить участки кода, которые требуют наличия
управляемых блокировок, и затем в этих участках кода установить требуемый режим
управляемой блокировки данных. Это можно осуществить двумя способами:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
с помощью объекта <span class="Term">БлокировкаДанных</span>;</p>

<p class="MsoListBulletCxSpLast">&#9679; 
с помощью свойства <span class="Term">БлокироватьДляИзменения</span>
у наборов записей регистров накопления и регистров бухгалтерии. Необходимая
управляемая блокировка будет автоматически установлена платформой в том случае,
если записывается набор записей регистра, у которого данное свойство имеет
значение <span class="Term">Истина</span>.</p>

<a id="TI000000539" class="bookmark" name="issogl3_9.3.7.2_определение_участков_кода_требующих_доработки"><h4>9.3.7.2. Определение участков кода, требующих доработки</h4></a>

<p class="MsoNormal">Управляемые блокировки необходимо устанавливать в тех участках
кода, которые удовлетворяют одному из следующих условий:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
Считываются данные, которые в дальнейшем должны
быть изменены.</p>

<p class="MsoListBulletCxSpMiddle">&#9679; 
Считывается некоторая согласованная совокупность
данных (содержащихся в нескольких объектах), и согласованность считанных данных
необходимо поддержать. В этом случае данные из этой совокупности должны быть
заблокированы либо единовременно перед считыванием, либо по мере считывания отдельных
элементов. Если некоторый элемент данных считывается однократно, не связан
логически с другими элементами данных и при этом не будет изменен в той же
транзакции, то его можно не блокировать.</p>

<p class="MsoListBulletCxSpLast">&#9679; 
Важно обеспечить неизменность считываемых данных
до конца транзакции. Например, некоторые данные, считываемые в транзакции,
могут быть прочитаны еще раз, и важно обеспечить их неизменность.</p>

<p class="MsoNormal">Типичным примером таких операций может служить запрос к
остаткам номенклатуры в модуле проведения документа.</p>

<a id="TI000000540" class="bookmark" name="issogl3_9.3.7.3_выбор_режима_управляемой_блокировки"><h4>9.3.7.3. Выбор режима управляемой блокировки</h4></a>

<p class="MsoNormal">Для операций, описанных выше, режим блокировки следует
устанавливать исходя из следующих соображений:</p>

<p class="MsoListBulletCxSpFirst">&#9679; 
<span class="Bold">Исключительный</span> режим
блокировки следует устанавливать для тех данных, которые должны быть изменены в
рамках этой же транзакции. Это позволит предотвратить конфликты блокировок.</p>

<p class="MsoListBulletCxSpLast">&#9679; 
<span class="Bold">Разделяемый</span> режим
блокировки следует устанавливать для тех данных, которые только считываются и
изменять которые не предполагается, но заблокировать от изменений все-таки
требуется.</p>

<a id="TI000000541" class="bookmark" name="issogl3_9.3.7.4_примеры_доработки_конфигурации"><h4>9.3.7.4. Примеры доработки конфигурации</h4></a>

<p class="MsoNormalCxSpFirst">Далее приведем пример установки управляемых блокировок
в модуле набора записей регистра накопления <span class="Term">ТоварыНаСкладах</span>.</p>

<p class="MsoNormalCxSpLast">Прежде всего, следует создать управляемую
блокировку:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">Блокировка <span class="operator">=</span> <span class="keyword">Новый</span> БлокировкаДанных<span class="operator">;</span></pre>

<p class="MsoNormal">Затем следует проанализировать текст запроса, формируемого в
модуле, и создать необходимые блокировки.</p>

<p class="Lang-parameter">Исключительная блокировка на регистр «ТоварыНаСкладах»</p>

<p class="MsoNormal">В ходе выполнения модуля набора записей формируется запрос,
содержащий следующий фрагмент:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// …</span>
ЛЕВОЕ СОЕДИНЕНИЕ
РегистрНакопления<span class="operator">.</span>ТоварыНаСкладах<span class="operator">.</span>Остатки<span class="operator">(</span><span class="operator">,</span>
    Номенклатура В <span class="operator">(</span><span class="keyword">ВЫБРАТЬ</span> РАЗЛИЧНЫЕ
        Номенклатура
        <span class="keyword">ИЗ</span>
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>Товары
        ГДЕ
        Ссылка <span class="operator">=</span> &ДокументСсылка<span class="operator">)</span><span class="operator">)</span>
<span class="comment">// …</span></pre>

<p class="MsoNormal">В данном случае нужно следует установить следующие блокировки:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">БлокировкаТоварыНаСкладах1 <span class="operator">=</span> Блокировка<span class="operator">.</span>
            Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыНаСкладах&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыНаСкладах1<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Исключительный<span class="operator">;</span>
БлокировкаТоварыНаСкладах1<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>Товары<span class="operator">;</span>
БлокировкаТоварыНаСкладах1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span> <span class="string">&quot;Номенклатура&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыНаСкладах1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;ХарактеристикаНоменклатуры&quot;</span><span class="operator">,</span><span class="string">&quot;ХарактеристикаНоменклатуры&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыНаСкладах1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Склад&quot;</span><span class="operator">,</span> <span class="string">&quot;Склад&quot;</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="Lang-parameter">Разделяемая блокировка на регистр «ТоварыВРезервеНаСкладах»</p>

<p class="MsoNormal">В ходе выполнения модуля формируется запрос, содержащий
следующий фрагмент:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// …</span>
ЛЕВОЕ СОЕДИНЕНИЕ
РегистрНакопления<span class="operator">.</span>ТоварыВРезервеНаСкладах<span class="operator">.</span>Остатки<span class="operator">(</span><span class="operator">,</span>
    Номенклатура В <span class="operator">(</span><span class="keyword">ВЫБРАТЬ</span> РАЗЛИЧНЫЕ
        Номенклатура
        <span class="keyword">ИЗ</span>
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>Товары
        ГДЕ
        Ссылка <span class="operator">=</span> &ДокументСсылка<span class="operator">)</span><span class="operator">)</span>
<span class="comment">// …</span></pre>

<p class="MsoNormal">В данном случае нужно установить следующие блокировки:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">БлокировкаТоварыВРезервеНаСкладах1 <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыВРезервеНаСкладах&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах1<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Разделяемый<span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах1<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>Товары<span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span> Номенклатура<span class="string">&quot;);</span>
<span class="string">БлокировкаТоварыВРезервеНаСкладах1.ИспользоватьИзИсточникаДанных(</span>
<span class="string">&quot;</span>ХарактеристикаНоменклатуры<span class="string">&quot;, &quot;</span>ХарактеристикаНоменклатуры<span class="string">&quot;);</span>
<span class="string">БлокировкаТоварыВРезервеНаСкладах1.ИспользоватьИзИсточникаДанных(&quot;</span>Склад<span class="string">&quot;, &quot;</span>Склад<span class="string">&quot;);</span></pre>

<p class="Lang-parameter">Разделяемая блокировка на регистр «ТоварыКПередачеСоСкладов»</p>

<p class="MsoNormal">В ходе выполнения модуля формируется запрос, содержащий
следующий фрагмент:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// …</span>
ЛЕВОЕ СОЕДИНЕНИЕ
РегистрНакопления<span class="operator">.</span>ТоварыКПередачеСоСкладов<span class="operator">.</span>Остатки<span class="operator">(</span><span class="operator">,</span>
    Номенклатура В <span class="operator">(</span><span class="keyword">ВЫБРАТЬ</span> РАЗЛИЧНЫЕ
        Номенклатура
        <span class="keyword">ИЗ</span>
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>Товары
        ГДЕ
        Ссылка <span class="operator">=</span> &ДокументСсылка<span class="operator">)</span><span class="operator">)</span>
<span class="comment">// …</span></pre>

<p class="MsoNormal">В данном случае нужно установить следующие блокировки:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">БлокировкаТоварыКПередачеСоСкладов1 <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыКПередачеСоСкладов&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов1<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Разделяемый<span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов1<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>Товары<span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;ХарактеристикаНоменклатуры&quot;</span><span class="operator">,</span> <span class="string">&quot;ХарактеристикаНоменклатуры&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов1<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Склад&quot;</span><span class="operator">,</span> <span class="string">&quot;Склад&quot;</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="Lang-parameter">Блокировки по табличной части «ВозвратнаяТара».
Исключительная блокировка на регистр «ТоварыНаСкладах»</p>

<p class="MsoNormal">В ходе выполнения модуля формируется запрос, содержащий
следующий фрагмент:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// …</span>
ЛЕВОЕ СОЕДИНЕНИЕ
РегистрНакопления<span class="operator">.</span>ТоварыНаСкладах<span class="operator">.</span>Остатки<span class="operator">(</span><span class="operator">,</span>
    Номенклатура В <span class="operator">(</span><span class="keyword">ВЫБРАТЬ</span> РАЗЛИЧНЫЕ
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара<span class="operator">.</span>Номенклатура
        <span class="keyword">ИЗ</span>
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара
        ГДЕ
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара<span class="operator">.</span>Ссылка <span class="operator">=</span>
<span class="preprocessor">            &amp;ДокументСсылка)</span>
        <span class="keyword">И</span> Качество <span class="operator">=</span> &<span class="keyword">Новый</span><span class="operator">)</span>
<span class="comment">// …</span></pre>

<p class="MsoNormal">В данном случае нужно установить следующие блокировки:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">БлокировкаТоварыНаСкладах2 <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыНаСкладах&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыНаСкладах2<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Исключительный<span class="operator">;</span>
БлокировкаТоварыНаСкладах2<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>ВозвратнаяТара<span class="operator">;</span>
БлокировкаТоварыНаСкладах2<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span> <span class="string">&quot;Номенклатура&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыНаСкладах2<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Склад&quot;</span><span class="operator">,</span> <span class="string">&quot;Склад&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыНаСкладах2<span class="operator">.</span>УстановитьЗначение<span class="operator">(</span><span class="string">&quot;Качество&quot;</span><span class="operator">,</span> Справочники<span class="operator">.</span>Качество<span class="operator">.</span>НайтиПоКоду<span class="operator">(</span><span class="string">&quot;1&quot;</span><span class="operator">)</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="Lang-parameter">Блокировки по табличной части «ВозвратнаяТара».
Разделяемая блокировка на регистр «ТоварыВРезервеНаСкладах»</p>

<p class="MsoNormal">В ходе выполнения модуля формируется запрос, содержащий следующий
фрагмент:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// …</span>
ЛЕВОЕ СОЕДИНЕНИЕ
РегистрНакопления<span class="operator">.</span>ТоварыВРезервеНаСкладах<span class="operator">.</span>Остатки<span class="operator">(</span><span class="operator">,</span>
    Номенклатура В <span class="operator">(</span><span class="keyword">ВЫБРАТЬ</span> РАЗЛИЧНЫЕ
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара<span class="operator">.</span>Номенклатура
        <span class="keyword">ИЗ</span>
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара
        ГДЕ
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара<span class="operator">.</span>Ссылка <span class="operator">=</span>
<span class="preprocessor">            &amp;ДокументСсылка)) КАК Резервы</span>
<span class="comment">// …</span></pre>

<p class="MsoNormal">В данном случае нужно установить следующие блокировки:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">БлокировкаТоварыВРезервеНаСкладах2 <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыВРезервеНаСкладах&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах2<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Разделяемый<span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах2<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>ВозвратнаяТара<span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах2<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыВРезервеНаСкладах2<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Склад&quot;</span><span class="operator">,</span> <span class="string">&quot;Склад&quot;</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="Lang-parameter">Блокировки по табличной части «ВозвратнаяТара».
Разделяемая блокировка на регистр «ТоварыКПередачеСоСкладов»</p>

<p class="MsoNormal">В ходе выполнения модуля формируется запрос, содержащий
следующий фрагмент:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev"><span class="comment">// …</span>
ЛЕВОЕ СОЕДИНЕНИЕ
РегистрНакопления<span class="operator">.</span>ТоварыКПередачеСоСкладов<span class="operator">.</span>Остатки<span class="operator">(</span><span class="operator">,</span>
    Номенклатура В <span class="operator">(</span><span class="keyword">ВЫБРАТЬ</span> РАЗЛИЧНЫЕ
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара<span class="operator">.</span>Номенклатура
        <span class="keyword">ИЗ</span>
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара
        ГДЕ
        Документ<span class="operator">.</span>РеализацияТоваровУслуг<span class="operator">.</span>ВозвратнаяТара<span class="operator">.</span>Ссылка <span class="operator">=</span>
<span class="preprocessor">            &amp;ДокументСсылка)) КАК ТоварыКПередаче</span>
<span class="comment">// …</span></pre>

<p class="MsoNormal">В данном случае нужно установить следующие блокировки:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">БлокировкаТоварыКПередачеСоСкладов2 <span class="operator">=</span> Блокировка<span class="operator">.</span>Добавить<span class="operator">(</span><span class="string">&quot;РегистрНакопления.ТоварыКПередачеСоСкладов&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов2<span class="operator">.</span>Режим <span class="operator">=</span> РежимБлокировкиДанных<span class="operator">.</span>Разделяемый<span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов2<span class="operator">.</span>ИсточникДанных <span class="operator">=</span> ДокументОбъект<span class="operator">.</span>ВозвратнаяТара<span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов2<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">,</span><span class="string">&quot;Номенклатура&quot;</span><span class="operator">)</span><span class="operator">;</span>
БлокировкаТоварыКПередачеСоСкладов2<span class="operator">.</span>ИспользоватьИзИсточникаДанных<span class="operator">(</span><span class="string">&quot;Склад&quot;</span><span class="operator">,</span> <span class="string">&quot;Склад&quot;</span><span class="operator">)</span><span class="operator">;</span></pre>

<p class="MsoNormal">После того как все необходимые блокировки созданы, следует
заблокировать перечисленные данные:</p>

<a class="copy_source" href="#_top" onClick="return false">Копировать в буфер обмена</a>
<pre class="src_dev">Блокировка<span class="operator">.</span>Заблокировать<span class="operator">(</span><span class="operator">)</span><span class="operator">;</span>
<span class="comment">// … далее следует прежний текст модуля</span></pre>

<br>

<a name="_ref214262205"></a><a name="_ref346815249"></a><a name="_ref388541160"></a><a name="_ref388541159"></a><a id="TI000000542" class="bookmark" name="issogl1_9.4_монопольный_режим"><h2>9.4. Монопольный режим</h2></a>

<p class="MsoNormalCxSpFirst"><span class="Bold">Монопольный режим</span> – специальный режим доступа к базе
данных, при использовании которого работать с базой данных можно, используя
только один сеанс. Монопольный режим можно использовать в тех случаях, когда
требуется выполнить существенные, согласованные, изменения с информационной
базой, которые нет необходимости выполнять в рамках транзакции. При этом
желательно исключить влияние других сеансов на результаты изменения. Установку
монопольного режима требуют некоторые методы встроенного языка (например, метод
<span class="Term">УдалитьОбъекты()</span>),
а также работа Конфигуратора.</p>

<p class="MsoNormalCxSpMiddle">Для
установки или снятия монопольного режима необходимо использовать метод
глобального контекста <span class="Term">УстановитьМонопольныйРежим()</span>.
Проверить установку монопольного режима можно с помощью метода <span class="Term">МонопольныйРежим()</span>. Невозможно изменить
состояние монопольного режима в том случае, если активна транзакция (явная или
неявная).</p>

<p class="MsoNormalCxSpMiddle">Сеанс может установить монопольный режим, если нет других
сеансов работы с этой информационной базой. В монопольном режиме запрещено
создание новых сеансов с данной информационной базой за исключением запуска
одного фонового задания. Если из сеанса, который установил монопольный режим,
будет запущено фоновое задание, то запущенное фоновое задание «отнимет» монопольный
режим у родительского сеанса. Во время работы фонового задания родительский
сеанс не имеет возможности изменять данные в информационной базе. Монопольный
режим «вернется» к родительскому сеансу после того, как запущенное фоновое
задание будет завершено.</p>

<p class="MsoNormalCxSpMiddle">В случае работы в монопольном режиме не
устанавливаются управляемые блокировки (попытки их установки игнорируются).</p>

<p class="MsoNormalCxSpMiddle"> </p>

<br>		<script type="text/javascript">listenCopy('zeroclipboard.swf');</script>
	</body>
</html>